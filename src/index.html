<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Spotify Random Song Playlist</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
      }

      #app {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }

      h1 {
        margin-bottom: 0;
        font-size: 1.5em;
      }

      label {
        display: block;
        margin-top: 10px;
        font-size: 0.9em;
      }

      input {
        width: 80px;
        padding: 5px;
        font-size: 0.9em;
      }

      button {
        margin-top: 15px;
        padding: 15px;
        background-color: #1db954;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 1em;
      }

      button:hover {
        background-color: #1ed760;
      }

      #added-songs {
        margin-top: 10px;
        font-size: 0.9em;
      }

      #console {
        height: 120px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        font-size: 0.9em;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <h1>Spotify Random Track Playlist</h1>
      <h2>
        A number of random tracks up to, but almost certainly fewer than<em
          style="background-color: Tomato"
          >*</em
        >, the number chosen will be added to a playlist called "Random Songs
        from All of Spotify" (will be created if it doesn't exist).
      </h2>
      <h3>
        A third-party estimated limit of
        <em style="background-color: Tomato">~180 API requests per minute</em>
        are allowed by Spotify (1 track search = 1 request, + one or more
        requests for searching the user's playlists for the playlist to be added
        to or created). So if it doesn't work try waiting a minute and also
        consider reducing the number of songs to be added.
      </h3>
      <h4>
        Methodology: Searches for a random year between 1860 and the current
        year and chooses a track released that year, per Spotify, based on a
        random offset of the results (0 offset = first page of results, up to
        offset 1000 per Spotify's search limitation. Each page of results will
        randomly contain 1 to Spotify's maximum of 50 results).
        <p>
          <em style="background-color: Tomato">*</em>If it doesn't produce a
          valid result or if the API is overloaded there won't be a song added,
          so the total number will be fewer than the attempts chosen. This will
          find anything Spotify considers a track, so not necessarily just
          songs, but it won't find audiobooks as defined as such by Spotify, or
          podcast episodes. None of the tracks added per run will be duplicates
          of each other, but they CAN be tracks that are already on the playlist
          if it exists.
        </p>
      </h4>
      <div>
        <label for="numberOfSongs">Number of Tracks:</label>
        <input type="number" id="numberOfSongs" min="1" value="24" />
      </div>
      <button id="createPlaylistAndAddTracksButton">
        Create Playlist and/or Add Tracks
      </button>
      <div id="added-songs"></div>
      <div id="console"></div>
    </div>
    <script>
      const CLIENT_ID = "a34e83c02f6e439a891f4c2f6ba197fe";
      const REDIRECT_URI = "https://spotify-topaz-nine.vercel.app/";
      const SCOPES =
        "playlist-modify-public playlist-modify-private playlist-read-private";

      const addedSongsDiv = document.getElementById("added-songs");
      const consoleDiv = document.getElementById("console");

      const isAuthenticated = () => {
        const params = new URLSearchParams(window.location.hash.substring(1));
        return params.has("access_token");
      };

      const redirectToAuthorization = () => {
        window.location.href = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(
          REDIRECT_URI
        )}&scope=${encodeURIComponent(SCOPES)}&response_type=token`;
      };

      const getRandomYear = () => {
        const currentYear = new Date().getFullYear();
        return Math.floor(Math.random() * (currentYear - 1860 + 1)) + 1860;
      };

      const getRandomOffset = () => {
        return Math.floor(Math.random() * 1001);
      };

      const getRandomLimit = () => {
        return Math.floor(Math.random() * 50) + 1;
      };

      const searchTrackAndAddToPlaylist = async (
        accessToken,
        playlistUrl,
        year,
        addedSongs
      ) => {
        const randomOffset = getRandomOffset();
        const randomLimit = getRandomLimit();
        const searchUrl = `https://api.spotify.com/v1/search?type=track&q=year:${year}&offset=${randomOffset}&limit=${randomLimit}`;

        try {
          const response = await fetch(searchUrl, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          const data = await response.json();
          const tracks = data.tracks.items;

          if (tracks.length > 0) {
            const track = tracks[0];
            const trackUri = track.uri;

            const addResponse = await fetch(playlistUrl, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                uris: [trackUri],
              }),
            });

            if (addResponse.ok) {
              const trackInfo = {
                year,
                name: track.name,
                artist: track.artists.map((artist) => artist.name).join(", "),
                uri: trackUri,
              };
              addedSongs.push(trackInfo);
              console.log(`Track from ${year} added to playlist successfully`);
              logToConsole(`Track from ${year} added to playlist successfully`);
              return;
            } else {
              const errorMessage = `Error adding track to the playlist: ${addResponse.statusText}`;
              console.error(errorMessage);
              logToConsole(errorMessage);
            }
          } else {
            const errorMessage = `No track found for year ${year}`;
            console.error(errorMessage);
            logToConsole(errorMessage);
          }
        } catch (error) {
          const errorMessage = `Error searching for track: ${error.message}`;
          console.error(errorMessage);
          logToConsole(errorMessage);
        }
      };

      const addTracksToPlaylist = async (
        accessToken,
        playlistId,
        numberOfSongs
      ) => {
        const playlistUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;
        const addedSongs = [];
        const searchPromises = [];

        for (let i = 0; i < numberOfSongs; i++) {
          const randomYear = getRandomYear();
          searchPromises.push(
            searchTrackAndAddToPlaylist(
              accessToken,
              playlistUrl,
              randomYear,
              addedSongs
            )
          );
        }

        await Promise.all(searchPromises);

        const uniqueAddedSongs = [];
        const uniqueUris = new Set();
        addedSongs.forEach((song) => {
          if (!uniqueUris.has(song.uri)) {
            uniqueUris.add(song.uri);
            uniqueAddedSongs.push(song);
          }
        });

        addedSongsDiv.innerHTML = "<p>Added Songs:</p>";
        uniqueAddedSongs.forEach((song) => {
          addedSongsDiv.innerHTML += `<p>${song.year}: ${song.artist} - ${song.name} (${song.uri})</p>`;
        });
      };

      const searchPlaylist = async (accessToken, playlistName) => {
        let offset = 0;
        let playlist = null;

        try {
          while (!playlist) {
            const searchUrl = `https://api.spotify.com/v1/me/playlists?limit=50&offset=${offset}`;

            console.log("Searching playlists at offset", offset);

            const response = await fetch(searchUrl, {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            });

            console.log("Received response:", response);

            if (!response.ok) {
              throw new Error(
                "Error fetching playlists : " + response.statusText
              );
            }

            const data = await response.json();

            console.log("Received JSON data:", data);

            playlist = data.items.find((item) => item.name === playlistName);

            if (!playlist && data.next) {
              offset = 50;
            } else {
              break;
            }
          }

          console.log("Found playlist:", playlist);
          return playlist;
        } catch (error) {
          console.error("Error searching playlist:", error);
          alert("An error occurred while searching for the playlist");
          throw error;
        }
      };

      const createPlaylist = async (accessToken) => {
        const createPlaylistUrl = "https://api.spotify.com/v1/me/playlists";

        const response = await fetch(createPlaylistUrl, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name: "Random Songs from All of Spotify",
            public: true,
          }),
        });

        const data = await response.json();
        return data;
      };

      const createPlaylistAndAddTracks = async () => {
        if (!isAuthenticated()) {
          redirectToAuthorization();
          return;
        }

        const params = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = params.get("access_token");

        const playlist = await searchPlaylist(
          accessToken,
          "Random Songs from All of Spotify"
        );
        const playlistId = playlist
          ? playlist.id
          : (await createPlaylist(accessToken)).id;

        await addTracksToPlaylist(
          accessToken,
          playlistId,
          parseInt(document.getElementById("numberOfSongs").value)
        );
      };

      document.addEventListener("DOMContentLoaded", () => {
        if (!isAuthenticated()) {
          redirectToAuthorization();
        }
      });

      const button = document.getElementById(
        "createPlaylistAndAddTracksButton"
      );
      if (button) {
        button.addEventListener("click", createPlaylistAndAddTracks);
      } else {
        console.error(
          'Button with id "createPlaylistAndAddTracksButton" not found.'
        );
      }

      const logToConsole = (message) => {
        consoleDiv.innerHTML += `<p>${message}</p>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      };
    </script>
  </body>
</html>
